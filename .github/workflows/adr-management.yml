name: ðŸ“ adr
on:
  workflow_call:
    inputs:
      runs-on:
        description: 'Runner label for all jobs'
        required: false
        default: ubuntu-latest
        type: string
      repository:
        description: 'Repository to checkout and operate on (owner/repo)'
        required: true
        type: string
      ref:
        description: 'Git ref (SHA/branch) to checkout and operate on'
        required: true
        type: string
      base_ref:
        description: 'Base branch/ref to compare against (e.g., main)'
        required: false
        default: main
        type: string
      adr_glob:
        description: 'ADR file glob to watch (relative to repo root)'
        default: "docs/internal/designs/*.md"
        required: false
        type: string
      pr_number:
        description: 'Pull request number (required for commenting)'
        required: true
        type: number
      pr_url:
        description: 'Pull request URL (used in placeholder content)'
        required: true
        type: string
      commit_message:
        description: 'Custom commit message for reservation (optional). Use {{adr_numbers}} placeholder.'
        required: false
        type: string
permissions:
  contents: write
  pull-requests: write
jobs:
  manage-adrs:
    name: "push placeholder to ${{ inputs.base_ref }}"
    if: github.actor != 'github-actions[bot]'
    runs-on: ${{ inputs.runs-on }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
          fetch-depth: 0
      - name: Fetch base branch
        run: |
          set -euo pipefail
          git fetch --no-tags origin "${{ inputs.base_ref }}"
      - name: Detect new ADR files
        id: detect
        env:
          ADR_GLOB: ${{ inputs.adr_glob }}
          BASE_REF: ${{ inputs.base_ref }}
        run: |
          set -euo pipefail
          NEW_ADRS=$(git diff --name-only --diff-filter=A "origin/${BASE_REF}..HEAD" -- "$ADR_GLOB" || true)
          if [ -z "$NEW_ADRS" ]; then
            echo "has_new_adrs=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "has_new_adrs=true" >> $GITHUB_OUTPUT
          echo "$NEW_ADRS" > /tmp/new_adrs.txt
          echo "New ADR files:"
          cat /tmp/new_adrs.txt
      - name: Check for conflicts and process ADRs
        if: steps.detect.outputs.has_new_adrs == 'true'
        id: process
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ inputs.repository }}
          PR_NUMBER: ${{ inputs.pr_number }}
          PR_URL: ${{ inputs.pr_url }}
          BASE_REF: ${{ inputs.base_ref }}
          ADR_GLOB: ${{ inputs.adr_glob }}
        run: "set -euo pipefail\n\nhas_conflict=false\nconflict_messages=\"\"\nseen_numbers=\"\"\n\nwhile IFS= read -r adr_file; do\n  [ -z \"$adr_file\" ] && continue\n\n  adr_filename=$(basename \"$adr_file\")\n  adr_number=$(echo \"$adr_filename\" | grep -o '^[0-9]\\{3\\}' || echo \"\")\n\n  if [ -z \"$adr_number\" ]; then\n    echo \"Warning: Could not extract ADR number from $adr_filename\"\n    continue\n  fi\n\n  # Check for duplicate within this PR\n  if [[ \",$seen_numbers,\" == *\",$adr_number,\"* ]]; then\n    echo \"DUPLICATE: ADR $adr_number appears multiple times in this PR\"\n    has_conflict=true\n    conflict_messages=\"${conflict_messages}- \\`${adr_file}\\` uses number \\`${adr_number}\\` which is duplicated in this PR\\n\"\n  fi\n  seen_numbers=\"${seen_numbers},${adr_number}\"\n  # Check if this number already exists on the base branch\n  # Use ls-tree with the glob to find all relevant files, then grep for the specific number\n  # This handles both 001.md and 001-title.md patterns and avoids directory assumptions\n  existing=$(git ls-tree -r --name-only \"origin/${BASE_REF}\" -- \"$ADR_GLOB\" 2>/dev/null | grep -E \"(^|/)${adr_number}([^0-9]|$)\" | head -1 || true)\n\n  if [ -n \"$existing\" ]; then\n    echo \"CONFLICT: ADR $adr_number already exists on ${BASE_REF}: $existing\"\n    has_conflict=true\n    conflict_messages=\"${conflict_messages}- \\`${adr_file}\\` uses number \\`${adr_number}\\` which conflicts with \\`${existing}\\`\\n\"\n  fi\ndone < /tmp/new_adrs.txt\n\nif [ \"$has_conflict\" = \"true\" ]; then\n  echo \"has_conflict=true\" >> $GITHUB_OUTPUT\n\n  # Post a simple comment about conflict\n  cat <<EOF > /tmp/conflict_comment.md\n## âš ï¸ ADR Number Conflict\n\nOne or more ADR files in this PR use numbers that already exist on base branch \\`${BASE_REF}\\`:\n\n$(echo -e \"$conflict_messages\")\n\nPlease rename your ADR file(s) to use an available number.\nEOF\n  \n  gh pr comment \"$PR_NUMBER\" --body-file /tmp/conflict_comment.md\n  exit 0\nfi\necho \"has_conflict=false\" >> $GITHUB_OUTPUT\n"
      - name: Create and push placeholder to main
        if: steps.detect.outputs.has_new_adrs == 'true' && steps.process.outputs.has_conflict != 'true'
        uses: jmmaloney4/toolbox/.github/actions/create-adr-placeholder@main
        with:
          adr_files: /tmp/new_adrs.txt
          pr_url: ${{ inputs.pr_url }}
          pr_number: ${{ inputs.pr_number }}
          commit_message: ${{ inputs.commit_message }}
          base_branch: ${{ inputs.base_ref }}
