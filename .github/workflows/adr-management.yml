name: ADR Management

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'docs/internal/designs/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  manage-adrs:
    name: ADR Management
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0

    - name: Fetch main branch
      run: git fetch origin main:main

    - name: Detect new ADR files
      id: detect
      run: |
        NEW_ADRS=$(git diff --name-only --diff-filter=A main..HEAD -- 'docs/internal/designs/*.md' || true)
        if [ -z "$NEW_ADRS" ]; then
          echo "has_new_adrs=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        echo "has_new_adrs=true" >> $GITHUB_OUTPUT
        echo "$NEW_ADRS" > /tmp/new_adrs.txt
        echo "New ADR files:"
        cat /tmp/new_adrs.txt

    - name: Check for conflicts and process ADRs
      if: steps.detect.outputs.has_new_adrs == 'true'
      id: process
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        PR_URL: ${{ github.event.pull_request.html_url }}
      run: |
        set -euo pipefail

        has_conflict=false
        conflict_messages=""

        while IFS= read -r adr_file; do
          [ -z "$adr_file" ] && continue

          adr_filename=$(basename "$adr_file")
          adr_number=$(echo "$adr_filename" | grep -o '^[0-9]\{3\}' || echo "")

          if [ -z "$adr_number" ]; then
            echo "Warning: Could not extract ADR number from $adr_filename"
            continue
          fi

          # Check if this number already exists on main
          if git ls-tree main --name-only -- "docs/internal/designs/${adr_number}-"*.md 2>/dev/null | grep -q .; then
            existing=$(git ls-tree main --name-only -- "docs/internal/designs/${adr_number}-"*.md | head -1)
            echo "CONFLICT: ADR $adr_number already exists on main: $existing"
            has_conflict=true
            conflict_messages="${conflict_messages}- \`${adr_file}\` uses number \`${adr_number}\` which conflicts with \`${existing}\`\n"
          fi
        done < /tmp/new_adrs.txt

        if [ "$has_conflict" = "true" ]; then
          echo "has_conflict=true" >> $GITHUB_OUTPUT

          # Post a simple comment about the conflict
          gh pr comment "$PR_NUMBER" --body "## ⚠️ ADR Number Conflict

        One or more ADR files in this PR use numbers that already exist on the main branch:

        $(echo -e "$conflict_messages")

        Please rename your ADR file(s) to use an available number."
          exit 0
        fi

        echo "has_conflict=false" >> $GITHUB_OUTPUT

    - name: Create and push placeholder to main
      if: steps.detect.outputs.has_new_adrs == 'true' && steps.process.outputs.has_conflict != 'true'
      uses: ./.github/actions/create-adr-placeholder
      with:
        adr_files: /tmp/new_adrs.txt
        pr_url: ${{ github.event.pull_request.html_url }}
