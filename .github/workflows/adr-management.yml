name: ðŸ“„ adr management

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'docs/internal/designs/**'

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  manage-adrs:
    name: "ðŸ“„ adr management"
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_API_TOKEN }}

    steps:
    - name: Checkout PR branch
      if: env.ACT != 'true'
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0

    - name: Checkout main branch for comparison
      if: env.ACT != 'true'
      run: |
        git fetch origin main:main

    - name: Configure Git
      if: env.ACT != 'true'
      run: |
        git config --global user.name "GitHub Actions ADR Bot"
        git config --global user.email "actions@github.com"

    - name: Detect new ADR files
      id: detect-adrs
      run: |
        # Get list of new ADR files in this PR
        NEW_ADRS=$(git diff --name-only --diff-filter=A main..HEAD -- docs/internal/designs/ | grep '\.md$' || true)

        if [ -z "$NEW_ADRS" ]; then
          echo "No new ADR files found"
          echo "new_adrs=" >> $GITHUB_OUTPUT
          echo "has_new_adrs=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "New ADR files found:"
        echo "$NEW_ADRS"

        # Write file list to temp file for safe processing (avoids shell injection)
        echo "$NEW_ADRS" | jq -R -s -c 'split("\n") | map(select(length > 0))' > /tmp/new_adrs.json
        ADR_ARRAY=$(cat /tmp/new_adrs.json)
        echo "new_adrs=$ADR_ARRAY" >> $GITHUB_OUTPUT
        echo "has_new_adrs=true" >> $GITHUB_OUTPUT

    - name: Process ADR files
      if: steps.detect-adrs.outputs.has_new_adrs == 'true'
      run: |
        set -euo pipefail

        # Initialize NDJSON files for streaming writes
        : > /tmp/adr_success.ndjson
        : > /tmp/adr_conflicts.ndjson

        # Read from JSON file written in detect step (avoids shell injection)
        jq -r '.[]' /tmp/new_adrs.json | while IFS= read -r adr_file; do
          echo "Processing: $adr_file"

          # Extract ADR number from filename
          adr_filename=$(basename "$adr_file")
          adr_number=$(echo "$adr_filename" | grep -o '^[0-9]\{3\}-' | tr -d '-' || echo "")

          if [ -z "$adr_number" ]; then
            echo "Warning: Could not extract ADR number from $adr_filename"
            continue
          fi

          echo "ADR number: $adr_number"

          # Check if this number already exists on main
          git checkout main
          if ls docs/internal/designs/$adr_number*.md >/dev/null 2>&1; then
            existing_file=$(ls docs/internal/designs/$adr_number*.md 2>/dev/null | head -1)
            echo "CONFLICT: ADR number $adr_number already exists on main: $existing_file"

            # Store conflict info as NDJSON entry
            jq -n \
              --arg file "$adr_file" \
              --arg num "$adr_number" \
              --arg status "CONFLICT" \
              --arg existing "$existing_file" \
              '{"file": $file, "number": $num, "status": $status, "existing_file": $existing}' \
              >> /tmp/adr_conflicts.ndjson
          else
            echo "OK: ADR number $adr_number is available on main"

            # Store success info as NDJSON entry
            jq -n \
              --arg file "$adr_file" \
              --arg num "$adr_number" \
              '{"file": $file, "number": $num, "status": "OK"}' \
              >> /tmp/adr_success.ndjson
          fi

          # Switch back to PR branch
          git checkout ${{ github.event.pull_request.head.sha }}
        done

        # Merge NDJSON to JSON arrays
        if [ -s /tmp/adr_success.ndjson ]; then
          if ! jq -n '[inputs]' /tmp/adr_success.ndjson > /tmp/adr_success.json; then
            echo "âŒ CRITICAL: Failed to merge success entries to JSON" >&2
            exit 1
          fi
        fi

        if [ -s /tmp/adr_conflicts.ndjson ]; then
          if ! jq -n '[inputs]' /tmp/adr_conflicts.ndjson > /tmp/adr_conflicts.json; then
            echo "âŒ CRITICAL: Failed to merge conflict entries to JSON" >&2
            exit 1
          fi
        fi

    - name: Check success ADRs
      id: success-adrs
      if: steps.detect-adrs.outputs.has_new_adrs == 'true'
      run: |
        if [ -s /tmp/adr_success.json ]; then
          echo "has_success=true" >> $GITHUB_OUTPUT
        else
          echo "has_success=false" >> $GITHUB_OUTPUT
        fi

    - name: Create ADR placeholder files
      if: |
        steps.detect-adrs.outputs.has_new_adrs == 'true' &&
        steps.success-adrs.outputs.has_success == 'true'
      uses: ./.github/actions/create-adr-placeholder
      with:
        success_file: /tmp/adr_success.json
        pr_url: ${{ github.event.pull_request.html_url }}

    - name: Handle conflicting ADRs (add comments and create renaming PRs)
      if: steps.detect-adrs.outputs.has_new_adrs == 'true'
      uses: ./.github/actions/handle-adr-conflicts
      with:
        conflicts_file: /tmp/adr_conflicts.json
        pr_number: ${{ github.event.pull_request.number }}
        pr_head_ref: ${{ github.event.pull_request.head.ref }}
        pr_head_sha: ${{ github.event.pull_request.head.sha }}
        pr_url: ${{ github.event.pull_request.html_url }}

    - name: Create check status
      if: steps.detect-adrs.outputs.has_new_adrs == 'true'
      run: |
        set -euo pipefail

        # Count successes and conflicts
        success_count=0
        conflict_count=0

        if [ -s /tmp/adr_success.json ]; then
          success_count=$(jq 'length' /tmp/adr_success.json)
        fi

        if [ -s /tmp/adr_conflicts.json ]; then
          conflict_count=$(jq 'length' /tmp/adr_conflicts.json)
        fi

        if [ $conflict_count -gt 0 ]; then
          # Create a failing check for conflicts
          gh api \
            --method POST \
            /repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            --field state='failure' \
            --field target_url='${{ github.event.pull_request.html_url }}' \
            --field description="$conflict_count ADR number conflict(s) detected. Check PR comments for details." \
            --field context='ADR Number Validation'
        else
          # Create a success check
          gh api \
            --method POST \
            /repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            --field state='success' \
            --field target_url='${{ github.event.pull_request.html_url }}' \
            --field description="All $success_count ADR file(s) processed successfully." \
            --field context='ADR Number Validation'
        fi
