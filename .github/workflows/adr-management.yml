name: ðŸ“„ adr management

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
    - 'docs/internal/designs/**'

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  manage-adrs:
    name: "ðŸ“„ adr management"
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_API_TOKEN }}

    steps:
    - name: Checkout PR branch
      if: vars.SKIP_CHECKOUT != 'true'
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0

    - name: Checkout main branch for comparison
      run: |
        git fetch origin main:main

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions ADR Bot"
        git config --global user.email "actions@github.com"

    - name: Detect new ADR files
      id: detect-adrs
      run: |
        # Get list of new ADR files in this PR
        NEW_ADRS=$(git diff --name-only --diff-filter=A main..HEAD -- docs/internal/designs/ | grep '\.md$' || true)

        if [ -z "$NEW_ADRS" ]; then
          echo "No new ADR files found"
          echo "new_adrs=" >> $GITHUB_OUTPUT
          echo "has_new_adrs=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "New ADR files found:"
        echo "$NEW_ADRS"

        # Write file list to temp file for safe processing (avoids shell injection)
        echo "$NEW_ADRS" | jq -R -s -c 'split("\n") | map(select(length > 0))' > /tmp/new_adrs.json
        ADR_ARRAY=$(cat /tmp/new_adrs.json)
        echo "new_adrs=$ADR_ARRAY" >> $GITHUB_OUTPUT
        echo "has_new_adrs=true" >> $GITHUB_OUTPUT

    - name: Process ADR files
      if: steps.detect-adrs.outputs.has_new_adrs == 'true'
      run: |
        set -euo pipefail

        # Initialize NDJSON files for streaming writes
        : > /tmp/adr_success.ndjson
        : > /tmp/adr_conflicts.ndjson

        # Read from JSON file written in detect step (avoids shell injection)
        jq -r '.[]' /tmp/new_adrs.json | while IFS= read -r adr_file; do
          echo "Processing: $adr_file"

          # Extract ADR number from filename
          adr_filename=$(basename "$adr_file")
          adr_number=$(echo "$adr_filename" | grep -o '^[0-9]\{3\}-' | tr -d '-' || echo "")

          if [ -z "$adr_number" ]; then
            echo "Warning: Could not extract ADR number from $adr_filename"
            continue
          fi

          echo "ADR number: $adr_number"

          # Check if this number already exists on main
          git checkout main
          if ls docs/internal/designs/$adr_number-*.md >/dev/null 2>&1; then
            existing_file=$(ls docs/internal/designs/$adr_number-*.md 2>/dev/null | head -1)
            echo "CONFLICT: ADR number $adr_number already exists on main: $existing_file"

            # Store conflict info as NDJSON entry
            jq -n \
              --arg file "$adr_file" \
              --arg num "$adr_number" \
              --arg status "CONFLICT" \
              --arg existing "$existing_file" \
              '{"file": $file, "number": $num, "status": $status, "existing_file": $existing}' \
              >> /tmp/adr_conflicts.ndjson
          else
            echo "OK: ADR number $adr_number is available on main"
            # Store success info as NDJSON entry
            jq -n \
              --arg file "$adr_file" \
              --arg num "$adr_number" \
              '{"file": $file, "number": $num, "status": "OK"}' \
              >> /tmp/adr_success.ndjson
          fi

          # Switch back to PR branch
          git checkout ${{ github.event.pull_request.head.sha }}
        done

        # Merge NDJSON to JSON arrays
        if [ -s /tmp/adr_success.ndjson ]; then
          if ! jq -n '[inputs]' /tmp/adr_success.ndjson > /tmp/adr_success.json; then
            echo "âŒ CRITICAL: Failed to merge success entries to JSON" >&2
            exit 1
          fi
        fi

        if [ -s /tmp/adr_conflicts.ndjson ]; then
          if ! jq -n '[inputs]' /tmp/adr_conflicts.ndjson > /tmp/adr_conflicts.json; then
            echo "âŒ CRITICAL: Failed to merge conflict entries to JSON" >&2
            exit 1
          fi
        fi

    - name: Check success ADRs
      id: success-adrs
      if: steps.detect-adrs.outputs.has_new_adrs == 'true'
      run: |
        if [ -s /tmp/adr_success.json ]; then
          echo "has_success=true" >> $GITHUB_OUTPUT
        else
          echo "has_success=false" >> $GITHUB_OUTPUT
        fi

    - name: Create ADR placeholder files
      if: |
        steps.detect-adrs.outputs.has_new_adrs == 'true' &&
        steps.success-adrs.outputs.has_success == 'true'
      uses: ./.github/actions/create-adr-placeholder
      with:
        success_file: /tmp/adr_success.json
        pr_url: ${{ github.event.pull_request.html_url }}

    - name: Handle conflicting ADRs (add comments and create renaming PRs)
      if: steps.detect-adrs.outputs.has_new_adrs == 'true'
      run: |
        set -euo pipefail

        # Validate that JSON file exists from previous step
        if [ ! -s /tmp/adr_conflicts.json ]; then
          echo "No conflicting ADRs to process"
          exit 0
        fi

        # Validate JSON format before processing
        if ! jq empty /tmp/adr_conflicts.json 2>/dev/null; then
          echo "âŒ CRITICAL: /tmp/adr_conflicts.json is not valid JSON" >&2
          exit 1
        fi

        # Find next available ADR number
        # NOTE: ADR tracking migrated from base64 to JSON format (commit f510ddf9)
        # All file lists now use jq/JSON for safe shell processing
        git checkout main
        HIGHEST_NUM=$(ls docs/internal/designs/ | grep -o '^[0-9]\{3\}' | sort -n | tail -1 || echo "000")

        # Validate HIGHEST_NUM is a proper 3-digit number
        if [[ ! "$HIGHEST_NUM" =~ ^[0-9]{3}$ ]]; then
          echo "âŒ CRITICAL: Invalid ADR number format: '$HIGHEST_NUM'" >&2
          exit 1
        fi

        NEXT_NUM=$(printf "%03d" $((10#$HIGHEST_NUM + 1)))
        git checkout ${{ github.event.pull_request.head.sha }}

        jq -c '.[]' /tmp/adr_conflicts.json | while IFS= read -r entry; do
          status=$(echo "$entry" | jq -r '.status')
          if [ "$status" = "CONFLICT" ]; then
            adr_file=$(echo "$entry" | jq -r '.file')
            adr_number=$(echo "$entry" | jq -r '.number')
            existing_file=$(echo "$entry" | jq -r '.existing_file')
            echo "Handling conflict for $adr_file (number $adr_number)"

            # Add warning comment to the original PR
            gh pr comment ${{ github.event.pull_request.number }} --body "âš ï¸ **ADR Number Conflict Detected**

        The ADR file \`$adr_file\` uses number \`$adr_number\` which is already taken on the main branch.

        I'm automatically creating a PR to rename this file to use number \`$NEXT_NUM\` instead.

          **Original file:** \`$adr_file\`
          **Suggested rename:** \`$(dirname "$adr_file")/$NEXT_NUM-$(basename "$adr_file" | sed "s/^$adr_number-//")\`"

             # Create renaming PR against the current PR branch
            renaming_branch="adr-rename/$adr_number-to-$NEXT_NUM"
            existing_renaming_pr=$(gh pr list --base ${{ github.event.pull_request.head.ref }} --head "$renaming_branch" --json number --jq '.[0].number // empty' 2>/dev/null || echo "")

            if [ -n "$existing_renaming_pr" ]; then
              echo "Renaming PR already exists for ADR $adr_number -> $NEXT_NUM (PR #$existing_renaming_pr). Skipping creation."
              continue
            fi

            git checkout -b "$renaming_branch"

            # Get the new filename
            old_filename=$(basename "$adr_file")
            new_filename=$(echo "$old_filename" | sed "s/^$adr_number-/$NEXT_NUM-/")

             # Rename file, preserving subdirectory structure
             adr_dir=$(dirname "$adr_file")
             git mv "$adr_file" "$adr_dir/$new_filename"

             # Update any internal references to the ADR number in file content
             sed -i "s/ADR-$adr_number/ADR-$NEXT_NUM/g" "$adr_dir/$new_filename"
             sed -i "s/adr-$adr_number/adr-$NEXT_NUM/g" "$adr_dir/$new_filename"

             git add "$adr_dir/$new_filename"
            git commit -m "Rename ADR from $adr_number to $NEXT_NUM to resolve conflict

        The original ADR number $adr_number is already in use on the main branch.
        This commit renames the ADR to use the next available number: $NEXT_NUM."

            git push origin "$renaming_branch" --force-with-lease

            # Create PR against the original PR branch
            gh pr create \
              --title "Rename ADR from $adr_number to $NEXT_NUM (conflict resolution)" \
              --body "This PR automatically resolves an ADR number conflict detected in the parent PR.

        **Conflict:** ADR number \`$adr_number\` is already used on the main branch
        **Solution:** Rename to use the next available number \`$NEXT_NUM\`

          **Changes:**
          - Renamed \`$adr_file\` to \`$(dirname "$adr_file")/$NEXT_NUM-$(basename "$adr_file" | sed "s/^$adr_number-//")\`
          - Updated internal references from ADR-$adr_number to ADR-$NEXT_NUM

        **Next Steps:**
        1. Review and merge this PR into the parent branch
        2. The parent PR will be automatically re-processed
        3. A placeholder PR will be created against main with the new number" \
              --base ${{ github.event.pull_request.head.ref }} \
              --head "$renaming_branch" \
              --label "adr" \
              --label "conflict-resolution" \
              --label "automated"

            # Increment for the next conflict
            NEXT_NUM=$(printf "%03d" $((10#$NEXT_NUM + 1)))
            # Switch back to PR branch
            git checkout ${{ github.event.pull_request.head.sha }}
          fi
        done

    - name: Create check status
      if: steps.detect-adrs.outputs.has_new_adrs == 'true'
      run: |
        set -euo pipefail

        # Count successes and conflicts
        success_count=0
        conflict_count=0

        if [ -s /tmp/adr_success.json ]; then
          success_count=$(jq 'length' /tmp/adr_success.json)
        fi

        if [ -s /tmp/adr_conflicts.json ]; then
          conflict_count=$(jq 'length' /tmp/adr_conflicts.json)
        fi

        if [ $conflict_count -gt 0 ]; then
          # Create a failing check for conflicts
          gh api \
            --method POST \
            /repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            --field state='failure' \
            --field target_url='${{ github.event.pull_request.html_url }}' \
            --field description="$conflict_count ADR number conflict(s) detected. Check PR comments for details." \
            --field context='ADR Number Validation'
        else
          # Create a success check
          gh api \
            --method POST \
            /repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            --field state='success' \
            --field target_url='${{ github.event.pull_request.html_url }}' \
            --field description="All $success_count ADR file(s) processed successfully." \
            --field context='ADR Number Validation'
        fi
