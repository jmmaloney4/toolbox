name: ðŸ“„ adr management

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
    - 'docs/internal/designs/**'

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  manage-adrs:
    name: "ðŸ“„ adr management"
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_API_TOKEN }}

    steps:
    - name: Checkout PR branch
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0

    - name: Checkout main branch for comparison
      run: |
        git fetch origin main:main

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions ADR Bot"
        git config --global user.email "actions@github.com"

    - name: Detect new ADR files
      id: detect-adrs
      run: |
        # Get list of new ADR files in this PR
        NEW_ADRS=$(git diff --name-only --diff-filter=A main..HEAD -- docs/internal/designs/ | grep '\.md$' || true)

        if [ -z "$NEW_ADRS" ]; then
          echo "No new ADR files found"
          echo "new_adrs=" >> $GITHUB_OUTPUT
          echo "has_new_adrs=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "New ADR files found:"
        echo "$NEW_ADRS"

        # Write file list to temp file for safe processing (avoids shell injection)
        echo "$NEW_ADRS" | jq -R -s -c 'split("\n") | map(select(length > 0))' > /tmp/new_adrs.json
        ADR_ARRAY=$(cat /tmp/new_adrs.json)
        echo "new_adrs=$ADR_ARRAY" >> $GITHUB_OUTPUT
        echo "has_new_adrs=true" >> $GITHUB_OUTPUT

    - name: Process ADR files
      if: steps.detect-adrs.outputs.has_new_adrs == 'true'
      run: |
        # Read from JSON file written in detect step (avoids shell injection)
        jq -r '.[]' /tmp/new_adrs.json | while IFS= read -r adr_file; do
          echo "Processing: $adr_file"

          # Extract ADR number from filename
          adr_filename=$(basename "$adr_file")
          adr_number=$(echo "$adr_filename" | grep -o '^[0-9]\{3\}' || echo "")

          if [ -z "$adr_number" ]; then
            echo "Warning: Could not extract ADR number from $adr_filename"
            continue
          fi

          echo "ADR number: $adr_number"

          # Check if this number already exists on main
          git checkout main
          if ls docs/internal/designs/$adr_number-*.md >/dev/null 2>&1; then
            existing_file=$(ls docs/internal/designs/$adr_number-*.md 2>/dev/null | head -1)
            echo "CONFLICT: ADR number $adr_number already exists on main: $existing_file"

             # Store conflict info for later processing (base64 to handle colons in filenames)
            echo "$adr_file:$adr_number:CONFLICT" | base64 -w 0 >> /tmp/adr_conflicts.txt.b64
            echo "" >> /tmp/adr_conflicts.txt.b64
          else
            echo "OK: ADR number $adr_number is available on main"
            # Store success info for later processing (base64 to handle colons in filenames)
            echo "$adr_file:$adr_number:OK" | base64 -w 0 >> /tmp/adr_success.txt.b64
            echo "" >> /tmp/adr_success.txt.b64
          fi

          # Switch back to PR branch
          git checkout ${{ github.event.pull_request.head.sha }}
        done

    - name: Handle successful ADRs (create PRs to main)
      if: steps.detect-adrs.outputs.has_new_adrs == 'true'
      run: |
        if [ ! -f /tmp/adr_success.txt.b64 ]; then
          echo "No successful ADRs to process"
          exit 0
        fi

        while read -r encoded_line || [[ -n "$encoded_line" ]]; do
          decoded_line=$(echo "$encoded_line" | base64 -d)
          IFS=: read -r adr_file adr_number status <<< "$decoded_line"
          if [ "$status" = "OK" ]; then
            # Check if PR already exists for this ADR number
            existing_pr=$(gh pr list --base main --head "adr-sync/$adr_number" --json number --jq '.[0].number // empty' 2>/dev/null || echo "")

            if [ -n "$existing_pr" ]; then
              echo "PR already exists for ADR $adr_number (PR #$existing_pr). Skipping creation."
              continue
            fi

            echo "Creating PR to main for $adr_file"

            # Create a new branch for main PR
            branch_name="adr-sync/$adr_number"
            git checkout main
            git checkout -b "$branch_name"

            # Create directory if it doesn't exist
            mkdir -p docs/internal/designs

            # Create ADR file with just a link to original PR
            adr_filename=$(basename "$adr_file")
            cat > "docs/internal/designs/$adr_filename" << EOF
        # ADR $adr_number: $(echo "$adr_filename" | sed 's/^[0-9]\{3\}-//' | sed 's/\.md$//' | tr '-' ' ' | sed 's/\b\w/\u&/g')

        **Status:** Draft
        **Related PR:** ${{ github.event.pull_request.html_url }}

        This ADR is currently being developed in the linked pull request above.
        Please refer to that PR for current content and discussion.
        EOF

            # Commit and push
            git add "docs/internal/designs/$adr_filename"
            git commit -m "Add ADR placeholder for $adr_filename

        This ADR is being developed in PR #${{ github.event.pull_request.number }}.
        The content will be updated once the original PR is merged.

        Related: ${{ github.event.pull_request.html_url }}"

            git push origin "$branch_name" --force-with-lease

            # Create PR to main
            gh pr create \
              --title "Add ADR placeholder: $adr_filename" \
              --body "This ADR placeholder is automatically created for an ADR being developed in PR #${{ github.event.pull_request.number }}.

        **Original PR:** ${{ github.event.pull_request.html_url }}
        **ADR File:** \`$adr_file\`

        This placeholder will be updated with the full content once the original PR is merged." \
              --base main \
              --head "$branch_name" \
              --label "adr" \
              --label "automated"

            # Switch back to PR branch
            git checkout ${{ github.event.pull_request.head.sha }}
          fi
        done < /tmp/adr_success.txt.b64

    - name: Handle conflicting ADRs (add comments and create renaming PRs)
      if: steps.detect-adrs.outputs.has_new_adrs == 'true'
      run: |
        if [ ! -f /tmp/adr_conflicts.txt.b64 ]; then
          echo "No conflicting ADRs to process"
          exit 0
        fi

        # Find the next available ADR number
        git checkout main
        HIGHEST_NUM=$(ls docs/internal/designs/ | grep -o '^[0-9]\{3\}' | sort -n | tail -1)
        NEXT_NUM=$(printf "%03d" $((10#$HIGHEST_NUM + 1)))
        git checkout ${{ github.event.pull_request.head.sha }}

        while read -r encoded_line || [[ -n "$encoded_line" ]]; do
          decoded_line=$(echo "$encoded_line" | base64 -d)
          IFS=: read -r adr_file adr_number status <<< "$decoded_line"
          if [ "$status" = "CONFLICT" ]; then
            echo "Handling conflict for $adr_file (number $adr_number)"

            # Add warning comment to the original PR
            gh pr comment ${{ github.event.pull_request.number }} --body "âš ï¸ **ADR Number Conflict Detected**

        The ADR file \`$adr_file\` uses number \`$adr_number\` which is already taken on the main branch.

        I'm automatically creating a PR to rename this file to use number \`$NEXT_NUM\` instead.

         **Original file:** \`$adr_file\`
         **Suggested rename:** \`$(dirname "$adr_file")/$NEXT_NUM-$(basename "$adr_file" | sed "s/^$adr_number-//")\`"

         **Changes:**
         - Renamed \`$adr_file\` to \`$(dirname "$adr_file")/$new_filename\`
            # Create renaming PR against the current PR branch
            renaming_branch="adr-rename/$adr_number-to-$NEXT_NUM"
            existing_renaming_pr=$(gh pr list --base ${{ github.event.pull_request.head.ref }} --head "$renaming_branch" --json number --jq '.[0].number // empty' 2>/dev/null || echo "")

            if [ -n "$existing_renaming_pr" ]; then
              echo "Renaming PR already exists for ADR $adr_number -> $NEXT_NUM (PR #$existing_renaming_pr). Skipping creation."
              continue
            fi

            git checkout -b "$renaming_branch"

            # Get the new filename
            old_filename=$(basename "$adr_file")
            new_filename=$(echo "$old_filename" | sed "s/^$adr_number-/$NEXT_NUM-/")

             # Rename file, preserving subdirectory structure
             adr_dir=$(dirname "$adr_file")
             git mv "$adr_file" "$adr_dir/$new_filename"

             # Update any internal references to the ADR number in file content
             sed -i "s/ADR-$adr_number/ADR-$NEXT_NUM/g" "$adr_dir/$new_filename"
             sed -i "s/adr-$adr_number/adr-$NEXT_NUM/g" "$adr_dir/$new_filename"

             git add "$adr_dir/$new_filename"
            git commit -m "Rename ADR from $adr_number to $NEXT_NUM to resolve conflict

        The original ADR number $adr_number is already in use on the main branch.
        This commit renames the ADR to use the next available number: $NEXT_NUM."

            git push origin "$renaming_branch" --force-with-lease

            # Create PR against the original PR branch
            gh pr create \
              --title "Rename ADR from $adr_number to $NEXT_NUM (conflict resolution)" \
              --body "This PR automatically resolves an ADR number conflict detected in the parent PR.

        **Conflict:** ADR number \`$adr_number\` is already used on the main branch
        **Solution:** Rename to use the next available number \`$NEXT_NUM\`

         **Changes:**
         - Renamed \`$adr_file\` to \`$(dirname "$adr_file")/$new_filename\`
         - Updated internal references from ADR-$adr_number to ADR-$NEXT_NUM

        **Next Steps:**
        1. Review and merge this PR into the parent branch
        2. The parent PR will be automatically re-processed
        3. A placeholder PR will be created against main with the new number" \
              --base ${{ github.event.pull_request.head.ref }} \
              --head "$renaming_branch" \
              --label "adr" \
              --label "conflict-resolution" \
              --label "automated"

            # Increment for the next conflict
            NEXT_NUM=$(printf "%03d" $((10#$NEXT_NUM + 1)))
            # Switch back to PR branch
            git checkout ${{ github.event.pull_request.head.sha }}
          fi
        done < /tmp/adr_conflicts.txt.b64

    - name: Create check status
      if: steps.detect-adrs.outputs.has_new_adrs == 'true'
      run: |-
        # Count successes and conflicts
        success_count=0
        conflict_count=0

        if [ -f /tmp/adr_success.txt.b64 ]; then
          success_count=$(wc -l < /tmp/adr_success.txt.b64)
        fi

        if [ -f /tmp/adr_conflicts.txt.b64 ]; then
          conflict_count=$(wc -l < /tmp/adr_conflicts.txt.b64)
        fi

        if [ $conflict_count -gt 0 ]; then
          # Create a failing check for conflicts
          gh api \
            --method POST \
            /repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            --field state='failure' \
            --field target_url='${{ github.event.pull_request.html_url }}' \
            --field description="$conflict_count ADR number conflict(s) detected. Check PR comments for details." \
            --field context='ADR Number Validation'
        else
          # Create a success check
          gh api \
            --method POST \
            /repos/${{ github.repository }}/statuses/${{ github.event.pull_request.head.sha }} \
            --field state='success' \
            --field target_url='${{ github.event.pull_request.html_url }}' \
            --field description="All $success_count ADR file(s) processed successfully." \
            --field context='ADR Number Validation'
        fi
