# Rust CI/CD Pipeline
# 
# A comprehensive Rust CI pipeline with cargo check, test, and clippy.
# Uses Nix flake devshells for reproducible Rust toolchains and dependencies.
#
# Usage:
# ```yaml
# jobs:
#   rust:
#     uses: jmmaloney4/workflows/.github/workflows/rust.yml@main
#     with:
#       flake-ref: "."  # Use default devshell from ./flake.nix
#       test-runner: "nextest"
#       clippy-args: "--all-targets --all-features"
#       runs-on: "ubuntu-latest"
#   rust-custom:
#     uses: jmmaloney4/workflows/.github/workflows/rust.yml@main
#     with:
#       flake-ref: ".#rust-dev"  # Use specific devshell
#       test-runner: "cargo-test"
# ```

name: "ü¶Ä Rust"

on:
  workflow_call:
    inputs:
      flake-ref:
        description: "Flake reference (e.g., '.', '.#rust-dev', 'github:owner/repo#devshell')"
        required: false
        type: string
        default: "."
      test-runner:
        description: "Test runner to use (cargo-test or nextest)"
        required: false
        type: string
        default: "cargo-test"
      clippy-args:
        description: "Additional arguments for clippy"
        required: false
        type: string
        default: "--all-targets"
      runs-on:
        description: "Runner to use for jobs"
        required: false
        type: string
        default: "ubuntu-latest"
      cache-key-suffix:
        description: "Additional suffix for cache keys"
        required: false
        type: string
        default: ""
      skip-clippy:
        description: "Skip clippy checks"
        required: false
        type: boolean
        default: false
    outputs:
      cache-key:
        description: "Cache key used for Cargo cache"
        value: ${{ jobs.cargo-check.outputs.cache-key }}

permissions:
  contents: read
  checks: write

jobs:
  cargo-check:
    name: "üî¨ cargo check"
    runs-on: ${{ inputs.runs-on }}
    outputs:
      cache-key: ${{ steps.rust-setup.outputs.cache-key }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Nix
      uses: jmmaloney4/workflows/.github/actions/nix-setup@main

    - name: Setup Rust with caching
      id: rust-setup
      uses: jmmaloney4/workflows/.github/actions/rust-cache-setup@main
      with:
        flake-ref: ${{ inputs.flake-ref }}
        cache-key-suffix: ${{ inputs.cache-key-suffix }}
        cache-group: "cargo-check"

    - name: Cargo check
      shell: bash
      run: nix develop ${{ inputs.flake-ref }} -c cargo check

  cargo-test:
    name: "üß™ cargo test"
    needs: cargo-check
    runs-on: ${{ inputs.runs-on }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Nix
      uses: jmmaloney4/workflows/.github/actions/nix-setup@main

    - name: Setup Rust with caching
      uses: jmmaloney4/workflows/.github/actions/rust-cache-setup@main
      with:
        flake-ref: ${{ inputs.flake-ref }}
        cache-key-suffix: ${{ inputs.cache-key-suffix }}
        cache-group: "cargo-test"

    - name: Run tests with nextest
      if: ${{ inputs.test-runner == 'nextest' }}
      shell: bash
      run: |
        set -euo pipefail
        nix develop ${{ inputs.flake-ref }} -c cargo nextest run --config-file nextest.toml --profile ci --hide-progress-bar --test-threads 4

    - name: Run tests with cargo test
      if: ${{ inputs.test-runner == 'cargo-test' }}
      shell: bash
      run: nix develop ${{ inputs.flake-ref }} -c cargo test

    - name: Test Report (nextest)
      if: ${{ inputs.test-runner == 'nextest' && !cancelled() }}
      uses: dorny/test-reporter@v2
      with:
        name: Rust tests
        path: target/nextest/ci/junit.xml
        reporter: java-junit

  cargo-clippy:
    name: "üßë‚Äçüè´ cargo clippy"
    if: ${{ !inputs.skip-clippy }}
    needs: cargo-check
    runs-on: ${{ inputs.runs-on }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Nix
      uses: jmmaloney4/workflows/.github/actions/nix-setup@main

    - name: Setup Rust with caching
      uses: jmmaloney4/workflows/.github/actions/rust-cache-setup@main
      with:
        flake-ref: ${{ inputs.flake-ref }}
        cache-key-suffix: ${{ inputs.cache-key-suffix }}
        cache-group: "cargo-clippy"

    - name: Cargo clippy
      shell: bash
      run: |
        set -euo pipefail
        nix develop ${{ inputs.flake-ref }} -c sh -c 'cargo clippy ${{ inputs.clippy-args }} --message-format=json | cargo-action-fmt || true'