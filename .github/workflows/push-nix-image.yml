name: 'ðŸš€ Push Nix Image to Registry'
on:
  workflow_call:
    inputs:
      runs-on:
        description: 'Runner label(s) for all jobs (string label or JSON array of labels)'
        required: true
        type: string
      package-name:
        description: 'Nix package name (e.g., zeus-image, ci-image)'
        required: true
        type: string
      registry:
        description: 'Container registry (default: ghcr.io)'
        required: false
        type: string
        default: 'ghcr.io'
      namespace:
        description: 'Registry namespace (e.g., org/repo)'
        required: true
        type: string
      image-name:
        description: 'Image name in registry (defaults to package-name without -image suffix)'
        required: false
        type: string
      tags:
        description: 'Comma-separated list of tags (e.g., latest,v1.0.0,pr-123)'
        required: true
        type: string
      system:
        description: 'Nix system (default: x86_64-linux)'
        required: false
        type: string
        default: 'x86_64-linux'
      repository:
        description: 'Repository to checkout'
        required: true
        type: string
      ref:
        description: 'Git ref to checkout'
        required: true
        type: string
      google_workload_identity_provider:
        description: 'GCP Workload Identity Provider (optional, for GCR/GAR)'
        required: false
        type: string
      google_service_account_email:
        description: 'GCP service account email (optional, for GCR/GAR)'
        required: false
        type: string
    secrets:
      REGISTRY_USERNAME:
        description: 'Registry username (defaults to github.actor)'
        required: false
      REGISTRY_PASSWORD:
        description: 'Registry password/token (usually GITHUB_TOKEN)'
        required: true
jobs:
  push-image:
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJson(inputs.runs-on) || inputs.runs-on }}
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
      - name: Authenticate to Google Cloud
        if: inputs.google_workload_identity_provider != ''
        uses: jmmaloney4/toolbox/.github/actions/gcp-auth@main
        with:
          workload_identity_provider: ${{ inputs.google_workload_identity_provider }}
          service_account_email: ${{ inputs.google_service_account_email }}
          install_gcloud: 'true'
      - name: Install Nix
        uses: jmmaloney4/toolbox/.github/actions/nix-setup@main
        with:
          runs-on: ${{ inputs.runs-on }}
          cache: ${{ !contains(inputs.runs-on, 'self-hosted') }}
      - name: Push Nix Image
        uses: jmmaloney4/toolbox/.github/actions/push-nix-image@main
        with:
          package-name: ${{ inputs.package-name }}
          registry: ${{ inputs.registry }}
          namespace: ${{ inputs.namespace }}
          image-name: ${{ inputs.image-name }}
          tags: ${{ inputs.tags }}
          system: ${{ inputs.system }}
          use-gcp-auth: ${{ inputs.google_workload_identity_provider != '' }}
          registry-username: ${{ secrets.REGISTRY_USERNAME || github.actor }}
          registry-password: ${{ secrets.REGISTRY_PASSWORD }}
