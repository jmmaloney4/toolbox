name: ðŸ“Š quarto
on:
  push:
    branches: [main] # production deploys
  pull_request: # perâ€‘PR preview deploys
    types: [opened, synchronize, reopened]
permissions: # required by the action
  actions: read # (only for private repos)
  contents: read
  deployments: write
  pull-requests: write
jobs:
  deploy:
    runs-on: ${{ vars.ACTIONS_RUNS_ON }}
    permissions:
      id-token: write
      actions: read
      contents: read
      deployments: write
      pull-requests: write
    env:
      DIST: research/_site
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
      - uses: jmmaloney4/toolbox/.github/actions/nix-setup@main
      - name: Build site with Nix
        run: |
          nix develop -c quarto render ./research
      - name: Validate build output
        run: |
          if [ ! -d "${{ env.DIST }}" ]; then
            echo "Build output directory not found"
            exit 1
          fi
          if [ ! -f "${{ env.DIST }}/index.html" ]; then
            echo "Index page not generated"
            ls -la "${{ env.DIST }}"
            exit 1
          fi
      - name: Deploy to Cloudflare Pages
        id: pages
        uses: andykenward/github-actions-cloudflare-pages@v3.0.1
        with:
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_PAGES_API_TOKEN }}
          cloudflare-account-id: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          cloudflare-project-name: zeus
          directory: ${{ env.DIST }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # main â†’ production, everything else â†’ preview
          github-environment: ${{ (github.ref == 'refs/heads/main' && 'research-production') || 'research-preview' }}
