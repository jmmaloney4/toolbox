name: '‚ùÑÔ∏è nix'
on:
  workflow_call:
    inputs:
      runs-on:
        description: 'Runner label(s) for all jobs (string label or JSON array of labels)'
        required: false
        default: 'runs-on=${{ github.run_id }}/runner=2cpu-linux-x64/extras=s3-cache'
        type: string
      repository:
        description: 'Repository to checkout and build (format: owner/repo)'
        required: true
        type: string
      ref:
        description: 'Git ref to checkout and build'
        required: true
        type: string
      image-namespace:
        description: 'Namespace to push docker images to (e.g. cavinsresearch or jmmaloney4)'
        required: false
        default: 'cavinsresearch'
        type: string
      registry:
        description: 'Container registry (ghcr.io, gcr.io, us-docker.pkg.dev, etc.)'
        required: false
        default: 'ghcr.io'
        type: string
      google_workload_identity_provider:
        description: 'GCP Workload Identity Provider (required for GCR/GAR)'
        required: false
        type: string
      google_service_account_email:
        description: 'GCP service account email (required for GCR/GAR)'
        required: false
        type: string
    secrets:
      REGISTRY_PASSWORD:
        description: 'Registry password/token (usually GITHUB_TOKEN)'
        required: false
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
  id-token: write
  packages: write
jobs:
  detect:
    name: '‚òÉÔ∏è detect flake outputs'
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJson(inputs.runs-on) || inputs.runs-on }}
    outputs:
      matrix_include: ${{ steps.compute.outputs.matrix_include }}
      has_work: ${{ steps.compute.outputs.has_work }}
      images_to_push: ${{ steps.images.outputs.image_matrix }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
      - uses: jmmaloney4/toolbox/.github/actions/nix-setup@main
        with:
          runs-on: ${{ inputs.runs-on }}
          cache: ${{ !contains(inputs.runs-on, 'self-hosted') }}
      - name: compute build-needed matrix via nix-eval-jobs
        id: compute
        uses: jmmaloney4/toolbox/.github/actions/compute-flake-build-matrix@main
        with:
          probe-timeout-seconds: '180'
      - name: compute images to push
        id: images
        shell: 'nix shell nixpkgs#jq -c bash {0}'
        run: |
          # Use jq to filter the matrix for entries where is_image is true,
          # then extract just the package name (the 'name' field)
          # into a list for the downstream matrix.
          image_names=$(echo '${{ steps.compute.outputs.matrix_include }}' | jq -c '[ .[] | select(.is_image == true) | .name ]')
          echo "Found images: $image_names"
          echo "image_matrix=$image_names" >> "$GITHUB_OUTPUT"
  build:
    name: "üë∑‚Äç‚ôÇÔ∏è ${{ matrix.category }}.${{ matrix.system }}.${{ matrix.name }}"
    needs: [detect]
    runs-on: ${{ startsWith(inputs.runs-on, '[') && fromJson(inputs.runs-on) || inputs.runs-on }}
    if: ${{ needs.detect.outputs.has_work == 'true' }}
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include: ${{ fromJson(needs.detect.outputs.matrix_include) }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          repository: ${{ inputs.repository }}
          ref: ${{ inputs.ref }}
      - uses: jmmaloney4/toolbox/.github/actions/nix-setup@main
        with:
          runs-on: ${{ inputs.runs-on }}
          cache: ${{ !contains(inputs.runs-on, 'self-hosted') }}
      - name: "üöÄ build with nix-fast-build"
        shell: 'nix -L shell nixpkgs#nix-fast-build -c bash {0}'
        run: |-
          set -euo pipefail
          attr='${{ matrix.flake_attr }}'
          echo "Building via nix-fast-build: $attr"
          # Build only missing (uncached) derivations, with CI-friendly logs and no out-link
          nix-fast-build --skip-cached --no-nom --no-link --flake "$attr"
  push-images:
    name: "üê≥ push ${{ matrix.package-name }}"
    needs: [detect, build]
    # Only run if there are actually images to push
    if: ${{ needs.detect.outputs.images_to_push != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        package-name: ${{ fromJson(needs.detect.outputs.images_to_push) }}
    uses: jmmaloney4/toolbox/.github/workflows/push-nix-image.yml@main
    with:
      runs-on: ${{ inputs.runs-on }}
      package-name: ${{ matrix.package-name }}
      registry: ${{ inputs.registry }}
      namespace: ${{ inputs.image-namespace }}
      repository: ${{ inputs.repository }}
      ref: ${{ inputs.ref }}
      # Tag with PR number if PR, otherwise SHA + branch/latest
      tags: ${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.number) || format('sha-{0},{1}{2}', github.sha, github.ref_name, github.ref_name == 'main' && ',latest' || '') }}
      google_workload_identity_provider: ${{ inputs.google_workload_identity_provider }}
      google_service_account_email: ${{ inputs.google_service_account_email }}
    secrets:
      REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD || secrets.GITHUB_TOKEN }}
